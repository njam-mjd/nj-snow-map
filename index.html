<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expected Snowfall: Official NWS Forecast (NJ)</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.34/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.34/"></script>

  <style>
    html, body { height: 100%; width: 100%; margin: 0; }
    #wrap { height: 100%; width: 100%; display: flex; flex-direction: column; }

    #header {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      background: #ffffff;
      line-height: 1.2;
      display: flex;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    #headerLeft { display: flex; flex-direction: column; gap: 4px; }
    #title { font-size: 16px; font-weight: 800; margin: 0; }
    #meta { font-size: 12px; color: #4b5563; }

    /* “Two tweak knobs” control group */
    #controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
      font-size: 12px;
      color: #111827;
    }
    .control {
      display: flex;
      gap: 8px;
      align-items: center;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 6px 10px;
    }
    .control label { font-weight: 700; }
    .control input[type="range"] { width: 140px; }
    .control select {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 4px 8px;
      background: #fff;
    }

    #viewDiv { flex: 1; width: 100%; position: relative; }

    /* Right-side legend panel (styled like screenshot) */
    #legendPanel {
      position: absolute;
      right: 14px;
      top: 14px;
      z-index: 20;
      width: 140px;
      background: rgba(10, 10, 14, 0.78);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 10px;
      padding: 10px 10px 8px 10px;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
    }
    #legendTitle {
      font-size: 12px;
      font-weight: 800;
      margin: 0 0 8px 0;
      letter-spacing: 0.2px;
    }
    #legendInner {
      display: grid;
      grid-template-columns: 18px 1fr;
      gap: 6px 10px;
      align-items: center;
    }
    .swatch {
      width: 18px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid rgba(255,255,255,0.25);
    }
    .legLabel {
      font-size: 12px;
      line-height: 1.1;
      white-space: nowrap;
    }
    #legendFooter {
      margin-top: 8px;
      font-size: 10.5px;
      color: rgba(255,255,255,0.75);
      line-height: 1.2;
    }

    /* Make ArcGIS widgets fit */
    .esri-search { max-width: 340px; }
  </style>
</head>

<body>
  <div id="wrap">
    <div id="header">
      <div id="headerLeft">
        <div id="title">Expected Snowfall: Official NWS Forecast — New Jersey</div>
        <div id="meta">Loading valid period…</div>
      </div>

      <div id="controls">
        <div class="control">
          <label for="opacityKnob">Opacity</label>
          <input id="opacityKnob" type="range" min="0.30" max="0.95" step="0.01" value="0.72" />
          <span id="opacityValue">0.72</span>
        </div>
        <div class="control">
          <label for="blendKnob">Blend</label>
          <select id="blendKnob">
            <option value="multiply" selected>multiply</option>
            <option value="normal">normal</option>
            <option value="overlay">overlay</option>
          </select>
        </div>
      </div>
    </div>

    <div id="viewDiv">
      <!-- Custom legend overlay -->
      <div id="legendPanel" aria-label="Snowfall legend">
        <div id="legendTitle">Expected Snowfall (in.)</div>
        <div id="legendInner"></div>
        <div id="legendFooter">Official National Weather Service forecast</div>
      </div>
    </div>
  </div>

  <script>
    require([
      "esri/config",
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/widgets/Search",
      "esri/geometry/Polygon",
      "esri/geometry/SpatialReference",
      "esri/geometry/geometryEngine"
    ], function(
      esriConfig,
      Map,
      MapView,
      FeatureLayer,
      GraphicsLayer,
      Graphic,
      Search,
      Polygon,
      SpatialReference,
      geometryEngine
    ) {

      // -----------------------------
      // API KEY (use ?key=YOUR_KEY to avoid committing keys)
      // -----------------------------
      const DEFAULT_API_KEY = "PASTE_YOUR_ARCGIS_API_KEY_HERE";
      const urlKey = new URLSearchParams(window.location.search).get("key");
      const apiKey = urlKey || DEFAULT_API_KEY;

      if (apiKey && apiKey !== "PASTE_YOUR_ARCGIS_API_KEY_HERE") {
        esriConfig.apiKey = apiKey;
      } else {
        console.warn("No ArcGIS API key set. Basemap/geocoding may fail. Pass ?key=YOUR_KEY or edit DEFAULT_API_KEY.");
      }

      // -----------------------------
      // Color scheme (matched to screenshot palette feel)
      // Service bins: 0–1, 1–2, 2–3, 3–6, 6–12, 12–18, 18–24, 24–36, >36
      // -----------------------------
      const legendBins = [
        { grid: 1,   label: '0 - 1"',   color: [220, 235, 245, 255] },
        { grid: 2,   label: '1 - 2"',   color: [165, 215, 240, 255] },
        { grid: 3,   label: '2 - 3"',   color: [110, 185, 225, 255] },
        { grid: 6,   label: '3 - 6"',   color: [ 25, 120, 200, 255] },
        { grid: 12,  label: '6 - 12"',  color: [255, 230,   0, 255] },
        { grid: 18,  label: '12 - 18"', color: [255, 160,   0, 255] },
        { grid: 24,  label: '18 - 24"', color: [255,  60,   0, 255] },
        { grid: 36,  label: '24 - 36"', color: [190,   0,   0, 255] },
        { grid: 999, label: '>36"',     color: [170, 140, 235, 255] }
      ];

      function fillSymbol(rgba) {
        return {
          type: "simple-fill",
          color: rgba,
          outline: { type: "simple-line", color: [0,0,0,0], width: 0 } // no polygon outlines
        };
      }

      // -----------------------------
      // Layers
      // -----------------------------
      const snowfallLayer = new FeatureLayer({
        url: "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/NDFD_SnowFall_v1/FeatureServer/2",
        title: "Expected Snowfall (72-hour total)",
        opacity: 0.72,          // knob default
        blendMode: "multiply",  // knob default
        outFields: ["grid_code", "label", "fromdate", "todate"],
        popupEnabled: false
      });

      snowfallLayer.renderer = {
        type: "unique-value",
        field: "grid_code",
        defaultSymbol: fillSymbol([0,0,0,0]),
        uniqueValueInfos: legendBins.map(b => ({
          value: b.grid,
          label: b.label,
          symbol: fillSymbol(b.color)
        }))
      };

      // NJ municipality lookup for popup title + town search
      const municipalitiesLayer = new FeatureLayer({
        url: "https://services2.arcgis.com/XVOqAjTOJ5P6ngMu/arcgis/rest/services/NJ_Municipalities_3857/FeatureServer/0",
        title: "NJ Municipalities (lookup)",
        opacity: 0,
        visible: false,
        outFields: ["NAME", "MUN_TYPE", "COUNTY"]
      });

      // NJ mask (no border line)
      const statesLayer = new FeatureLayer({
        url: "https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/USA_States_Generalized_Boundaries/FeatureServer/0",
        title: "USA States (lookup)",
        opacity: 0,
        visible: false,
        outFields: ["STATE_ABBR"]
      });

      const maskLayer = new GraphicsLayer({ title: "NJ Mask" });

      // -----------------------------
      // Map + view (zoomed out one level)
      // -----------------------------
      const map = new Map({
        basemap: "streets-navigation-vector",
        layers: [snowfallLayer, maskLayer]
      });

      const view = new MapView({
        container: "viewDiv",
        map,
        center: [-74.55, 40.12],
        zoom: 7.9, // one level out from prior ~8.9
        constraints: { minZoom: 7, maxZoom: 13 }
      });

      // -----------------------------
      // Legend panel HTML build (right side, screenshot-like)
      // -----------------------------
      function buildLegendUI() {
        const inner = document.getElementById("legendInner");
        inner.innerHTML = "";
        // Highest at top like many NWS legends
        const binsTopDown = [...legendBins].reverse();
        for (const b of binsTopDown) {
          const sw = document.createElement("div");
          sw.className = "swatch";
          sw.style.background = `rgba(${b.color[0]},${b.color[1]},${b.color[2]},${(b.color[3]/255).toFixed(3)})`;

          const lab = document.createElement("div");
          lab.className = "legLabel";
          lab.textContent = b.label;

          inner.appendChild(sw);
          inner.appendChild(lab);
        }
      }
      buildLegendUI();

      // -----------------------------
      // “Two tweak knobs” wiring
      // -----------------------------
      const opacityKnob = document.getElementById("opacityKnob");
      const opacityValue = document.getElementById("opacityValue");
      opacityKnob.addEventListener("input", () => {
        const v = Number(opacityKnob.value);
        snowfallLayer.opacity = v;
        opacityValue.textContent = v.toFixed(2);
      });

      const blendKnob = document.getElementById("blendKnob");
      blendKnob.addEventListener("change", () => {
        snowfallLayer.blendMode = blendKnob.value;
      });

      // -----------------------------
      // Valid period display (header)
      // -----------------------------
      const fmtEnd = (ms) => {
        if (!ms) return "—";
        const d = new Date(ms);
        return d.toLocaleString(undefined, {
          weekday: "short", month: "short", day: "2-digit",
          hour: "2-digit", minute: "2-digit"
        });
      };

      async function updateValidPeriod() {
        const metaEl = document.getElementById("meta");
        try {
          const result = await snowfallLayer.queryFeatures({
            where: "1=1",
            outFields: ["fromdate", "todate"],
            returnGeometry: false,
            num: 1
          });

          if (!result.features.length) {
            metaEl.textContent = "Valid: unavailable";
            return;
          }

          const { fromdate, todate } = result.features[0].attributes;
          const start = fromdate
            ? new Date(fromdate).toLocaleString(undefined, { weekday:"short", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" })
            : "—";
          metaEl.textContent = `Valid: ${start} → ${fmtEnd(todate)} (auto-refreshes)`;
        } catch (e) {
          metaEl.textContent = "Valid: error loading";
          console.error(e);
        }
      }

      function startAutoRefresh() {
        setInterval(() => {
          snowfallLayer.refresh();
          updateValidPeriod();
        }, 10 * 60 * 1000);
      }

      // -----------------------------
      // NJ mask build (no border/outline stroke)
      // -----------------------------
      async function buildNjMask() {
        const nj = await statesLayer.queryFeatures({
          where: "STATE_ABBR = 'NJ'",
          outFields: ["STATE_ABBR"],
          returnGeometry: true,
          num: 1,
          outSpatialReference: view.spatialReference
        });

        if (!nj.features.length) return;
        const njGeom = nj.features[0].geometry;

        const sr = view.spatialReference || SpatialReference.WebMercator;
        const world = new Polygon({
          spatialReference: sr,
          rings: [[
            [-20037508, -20037508],
            [ 20037508, -20037508],
            [ 20037508,  20037508],
            [-20037508,  20037508],
            [-20037508, -20037508]
          ]]
        });

        const outsideNj = geometryEngine.difference(world, njGeom);

        maskLayer.removeAll();
        maskLayer.add(new Graphic({
          geometry: outsideNj,
          symbol: {
            type: "simple-fill",
            color: [255, 255, 255, 0.52],
            outline: { type: "simple-line", color: [0,0,0,0], width: 0 } // no border line
          }
        }));
      }

      // -----------------------------
      // Popup content (new format) + FIX for repeated "Township Township"
      // -----------------------------
      function municipalityTitle(attrs) {
        if (!attrs) return "Selected location";

        const nameRaw = (attrs.NAME || "").trim();
        const typeRaw = (attrs.MUN_TYPE || "").trim();

        if (!nameRaw) return "Selected location";
        if (!typeRaw) return nameRaw;

        const name = nameRaw.replace(/\s+/g, " ");
        const type = typeRaw.replace(/\s+/g, " ");

        const nameLC = name.toLowerCase();
        const typeLC = type.toLowerCase();

        // If NAME already contains the type word (e.g., "Toms River Township"), don't append again.
        const safeType = typeLC.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        const hasTypeWord = new RegExp("\\b" + safeType + "\\b", "i").test(name);
        const endsWithType = nameLC.endsWith(" " + typeLC);

        if (hasTypeWord || endsWithType) return name;
        return `${name} ${type}`;
      }

      async function getMunicipalityAtPoint(mapPoint) {
        try {
          const res = await municipalitiesLayer.queryFeatures({
            geometry: mapPoint,
            spatialRelationship: "intersects",
            outFields: ["NAME", "MUN_TYPE", "COUNTY"],
            returnGeometry: false,
            num: 1
          });
          return res.features.length ? res.features[0].attributes : null;
        } catch (e) {
          console.error(e);
          return null;
        }
      }

      async function getSnowAtPoint(mapPoint) {
        try {
          const res = await snowfallLayer.queryFeatures({
            geometry: mapPoint,
            spatialRelationship: "intersects",
            outFields: ["label", "todate"],
            returnGeometry: false,
            num: 1
          });
          return res.features.length ? res.features[0].attributes : null;
        } catch (e) {
          console.error(e);
          return null;
        }
      }

      function openPopup(mapPoint, munAttrs, snowAttrs) {
        const title = municipalityTitle(munAttrs);
        const expected = snowAttrs?.label ? snowAttrs.label : "—";
        const validUntil = snowAttrs?.todate ? fmtEnd(snowAttrs.todate) : "—";

        view.popup.open({
          location: mapPoint,
          title,
          content: `
            <div style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size: 13px; line-height: 1.25;">
              <div style="display:grid; grid-template-columns: 1fr; gap: 6px;">
                <div><b>Expected snowfall total:</b> ${expected}</div>
                <div><b>Valid until:</b> ${validUntil}</div>
                <div><b>Source:</b> Official National Weather Service forecast</div>
              </div>
            </div>
          `
        });
      }

      // -----------------------------
      // Search box (town OR zip)
      // -----------------------------
      function addSearchWidget() {
        const search = new Search({
          view,
          includeDefaultSources: false,
          locationEnabled: true,
          popupEnabled: false,
          sources: [
            {
              name: "NJ towns",
              placeholder: "Search NJ town (e.g., Toms River)",
              layer: municipalitiesLayer,
              searchFields: ["NAME"],
              displayField: "NAME",
              suggestionTemplate: "{NAME}",
              exactMatch: false,
              outFields: ["NAME", "MUN_TYPE", "COUNTY"],
              resultGraphicEnabled: false
            },
            {
              name: "ZIP / address",
              placeholder: "Search ZIP (e.g., 08753)",
              url: "https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer",
              singleLineFieldName: "SingleLine",
              resultGraphicEnabled: false
            }
          ]
        });

        view.ui.add(search, "top-left");

        search.on("select-result", async (evt) => {
          const feature = evt?.result?.feature;

          if (feature && feature.geometry) {
            await view.goTo({ target: feature.geometry, scale: 140000 });
            const center = feature.geometry.extent ? feature.geometry.extent.center : feature.geometry;
            const munAttrs = feature.attributes || null;
            const snowAttrs = await getSnowAtPoint(center);
            openPopup(center, munAttrs, snowAttrs);
          } else if (evt?.result?.extent) {
            await view.goTo(evt.result.extent.expand(1.2));
            const p = evt.result.feature?.geometry || evt.result.extent.center;
            const munAttrs = await getMunicipalityAtPoint(p);
            const snowAttrs = await getSnowAtPoint(p);
            openPopup(p, munAttrs, snowAttrs);
          }
        });
      }

      // -----------------------------
      // Init
      // -----------------------------
      view.when(async () => {
        addSearchWidget();
        await updateValidPeriod();
        startAutoRefresh();
        await buildNjMask();

        view.on("click", async (event) => {
          view.popup.close();
          const mapPoint = event.mapPoint;

          const [munAttrs, snowAttrs] = await Promise.all([
            getMunicipalityAtPoint(mapPoint),
            getSnowAtPoint(mapPoint)
          ]);

          openPopup(mapPoint, munAttrs, snowAttrs);
        });
      });

    });
  </script>
</body>
</html>
