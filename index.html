<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expected Snowfall: Official NWS Forecast (NJ)</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.34/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.34/"></script>

  <style>
    html, body { height: 100%; width: 100%; margin: 0; }
    #wrap { height: 100%; width: 100%; display: flex; flex-direction: column; }
    #header {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      background: #ffffff;
      line-height: 1.2;
    }
    #title { font-size: 16px; font-weight: 800; margin: 0; }
    #meta { font-size: 12px; color: #4b5563; margin-top: 4px; }
    #viewDiv { flex: 1; width: 100%; }
    .esri-legend { max-width: 260px; }
  </style>
</head>

<body>
  <div id="wrap">
    <div id="header">
      <div id="title">Expected Snowfall: Official NWS Forecast — New Jersey</div>
      <div id="meta">Loading valid period…</div>
    </div>
    <div id="viewDiv"></div>
  </div>

  <script>
    require([
      "esri/config",
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/widgets/Legend",
      "esri/widgets/Expand",
      "esri/geometry/Polygon",
      "esri/geometry/SpatialReference",
      "esri/geometry/geometryEngine"
    ], function(
      esriConfig,
      Map,
      MapView,
      FeatureLayer,
      GraphicsLayer,
      Graphic,
      Legend,
      Expand,
      Polygon,
      SpatialReference,
      geometryEngine
    ) {

      // -----------------------------
      // 1) API KEY
      // -----------------------------
      // Best practice: do NOT commit a real key to a public repo.
      // Use ?key=YOUR_KEY in the URL, or set DEFAULT_API_KEY for private deployments.
      const DEFAULT_API_KEY = "PASTE_YOUR_ARCGIS_API_KEY_HERE";
      const urlKey = new URLSearchParams(window.location.search).get("key");
      const apiKey = urlKey || DEFAULT_API_KEY;

      if (apiKey && apiKey !== "PASTE_YOUR_ARCGIS_API_KEY_HERE") {
        esriConfig.apiKey = apiKey;
      } else {
        console.warn("No ArcGIS API key set. Basemap may fail. Pass ?key=YOUR_KEY or edit DEFAULT_API_KEY.");
      }

      // -----------------------------
      // 2) Snowfall layer (NDFD 72h cumulative)
      // -----------------------------
      const snowfallLayer = new FeatureLayer({
        url: "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/NDFD_SnowFall_v1/FeatureServer/2",
        title: "Expected Snowfall (72-hour total)",
        opacity: 0.72,          // a bit more opaque since we removed polygon outlines
        blendMode: "multiply",  // helps geography show through
        outFields: ["grid_code", "label", "fromdate", "todate"],
        popupEnabled: false     // we will control popups on click
      });

      // MATCH THE “OFFICIAL NWS FORECAST” STYLE PALETTE (approx from your screenshot):
      // blue -> yellow -> orange/red -> purple (highest)
      // The service classes are grid_code = 1,2,3,6,12,18,24,36,999
      // (labels: 0-1, 1-2, 2-3, 3-6, 6-12, 12-18, 18-24, 24-36, >36)
      snowfallLayer.renderer = {
        type: "unique-value",
        field: "grid_code",
        defaultSymbol: {
          type: "simple-fill",
          color: [0, 0, 0, 0],
          outline: { type: "simple-line", color: [0, 0, 0, 0], width: 0 }
        },
        uniqueValueInfos: [
          { value: 1,   label: '0 - 1"',   symbol: fill([220, 235, 245, 255]) },
          { value: 2,   label: '1 - 2"',   symbol: fill([165, 215, 240, 255]) },
          { value: 3,   label: '2 - 3"',   symbol: fill([110, 185, 225, 255]) },
          { value: 6,   label: '3 - 6"',   symbol: fill([ 25, 120, 200, 255]) },
          { value: 12,  label: '6 - 12"',  symbol: fill([255, 230,   0, 255]) },
          { value: 18,  label: '12 - 18"', symbol: fill([255, 160,   0, 255]) },
          { value: 24,  label: '18 - 24"', symbol: fill([255,  60,   0, 255]) },
          { value: 36,  label: '24 - 36"', symbol: fill([190,   0,   0, 255]) },
          { value: 999, label: '>36"',     symbol: fill([170, 140, 235, 255]) }
        ]
      };

      function fill(rgba) {
        return {
          type: "simple-fill",
          color: rgba,
          outline: { type: "simple-line", color: [0, 0, 0, 0], width: 0 }
        };
      }

      // -----------------------------
      // 3) Municipality lookup (town name on click)
      // -----------------------------
      const municipalitiesLayer = new FeatureLayer({
        url: "https://services2.arcgis.com/XVOqAjTOJ5P6ngMu/arcgis/rest/services/NJ_Municipalities_3857/FeatureServer/0",
        title: "NJ Municipalities (lookup)",
        opacity: 0,
        visible: false,
        outFields: ["NAME", "MUN_TYPE", "COUNTY"]
      });

      // -----------------------------
      // 4) NJ mask (no border/outline)
      // -----------------------------
      const statesLayer = new FeatureLayer({
        url: "https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/USA_States_Generalized_Boundaries/FeatureServer/0",
        title: "USA States (lookup)",
        opacity: 0,
        visible: false,
        outFields: ["STATE_ABBR"]
      });

      const maskLayer = new GraphicsLayer({ title: "NJ Mask" });

      // -----------------------------
      // 5) Map + view (zoomed closer to NJ)
      // -----------------------------
      const map = new Map({
        basemap: "streets-navigation-vector",
        layers: [snowfallLayer, maskLayer]
      });

      const view = new MapView({
        container: "viewDiv",
        map,
        center: [-74.55, 40.12],
        zoom: 8.9,
        constraints: { minZoom: 7, maxZoom: 13 }
      });

      // Legend (collapsed)
      const legend = new Legend({ view });
      const legendExpand = new Expand({
        view,
        content: legend,
        expanded: false
      });
      view.ui.add(legendExpand, "top-right");

      // -----------------------------
      // Helpers
      // -----------------------------
      const fmt = (ms) => {
        if (!ms) return "—";
        const d = new Date(ms);
        return d.toLocaleString(undefined, {
          weekday: "short", month: "short", day: "2-digit",
          hour: "2-digit", minute: "2-digit"
        });
      };

      async function updateValidPeriod() {
        const metaEl = document.getElementById("meta");
        try {
          const result = await snowfallLayer.queryFeatures({
            where: "1=1",
            outFields: ["fromdate", "todate"],
            returnGeometry: false,
            num: 1
          });

          if (!result.features.length) {
            metaEl.textContent = "Valid period: unavailable";
            return;
          }

          const { fromdate, todate } = result.features[0].attributes;
          metaEl.textContent = `Valid: ${fmt(fromdate)} → ${fmt(todate)} (auto-refreshes)`;
        } catch (e) {
          metaEl.textContent = "Valid: error loading";
          console.error(e);
        }
      }

      function startAutoRefresh() {
        setInterval(() => {
          snowfallLayer.refresh();
          updateValidPeriod();
        }, 10 * 60 * 1000);
      }

      async function buildNjMask() {
        // Query NJ polygon from states layer
        const nj = await statesLayer.queryFeatures({
          where: "STATE_ABBR = 'NJ'",
          outFields: ["STATE_ABBR"],
          returnGeometry: true,
          num: 1,
          outSpatialReference: view.spatialReference
        });

        if (!nj.features.length) return;
        const njGeom = nj.features[0].geometry;

        // Big world rectangle in Web Mercator
        const sr = view.spatialReference || SpatialReference.WebMercator;
        const world = new Polygon({
          spatialReference: sr,
          rings: [[
            [-20037508, -20037508],
            [ 20037508, -20037508],
            [ 20037508,  20037508],
            [-20037508,  20037508],
            [-20037508, -20037508]
          ]]
        });

        const outsideNj = geometryEngine.difference(world, njGeom);

        maskLayer.removeAll();
        maskLayer.add(new Graphic({
          geometry: outsideNj,
          symbol: {
            type: "simple-fill",
            color: [255, 255, 255, 0.52], // dim outside NJ
            outline: { type: "simple-line", color: [0, 0, 0, 0], width: 0 } // NO border line
          }
        }));
      }

      async function getMunicipalityName(mapPoint) {
        try {
          const res = await municipalitiesLayer.queryFeatures({
            geometry: mapPoint,
            spatialRelationship: "intersects",
            outFields: ["NAME", "COUNTY", "MUN_TYPE"],
            returnGeometry: false,
            num: 1
          });
          if (!res.features.length) return null;
          const a = res.features[0].attributes;
          return a.COUNTY ? `${a.NAME} (${a.COUNTY} County)` : a.NAME;
        } catch (e) {
          console.error(e);
          return null;
        }
      }

      async function getSnowBinAtPoint(mapPoint) {
        try {
          const res = await snowfallLayer.queryFeatures({
            geometry: mapPoint,
            spatialRelationship: "intersects",
            outFields: ["label", "fromdate", "todate"],
            returnGeometry: false,
            num: 1
          });
          if (!res.features.length) return null;
          return res.features[0].attributes;
        } catch (e) {
          console.error(e);
          return null;
        }
      }

      function openPopup(mapPoint, town, snowAttrs) {
        const townLine = town ? `<div><b>Town:</b> ${town}</div>` : `<div><b>Town:</b> —</div>`;
        const snowLine = snowAttrs?.label ? `<div><b>Expected snowfall:</b> ${snowAttrs.label}</div>` : `<div><b>Expected snowfall:</b> —</div>`;
        const validLine = (snowAttrs?.fromdate && snowAttrs?.todate)
          ? `<div><b>Valid:</b> ${fmt(snowAttrs.fromdate)} → ${fmt(snowAttrs.todate)}</div>`
          : `<div><b>Valid:</b> —</div>`;

        view.popup.open({
          location: mapPoint,
          title: "Expected Snowfall (Official NWS Forecast)",
          content: `
            <div style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;">
              ${townLine}
              ${snowLine}
              ${validLine}
            </div>
          `
        });
      }

      // -----------------------------
      // Init
      // -----------------------------
      view.when(async () => {
        await updateValidPeriod();
        startAutoRefresh();
        await buildNjMask();

        view.on("click", async (event) => {
          view.popup.close();
          const mapPoint = event.mapPoint;

          const [town, snowAttrs] = await Promise.all([
            getMunicipalityName(mapPoint),
            getSnowBinAtPoint(mapPoint)
          ]);

          openPopup(mapPoint, town, snowAttrs);
        });
      });
    });
  </script>
</body>
</html>
